apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-values
  namespace: monitoring
data:
  values.yaml: |
    # Deployment mode - must be SingleBinary for monolithic deployment
    deploymentMode: SingleBinary

    loki:
      # Authentication and authorization settings
      auth_enabled: false

      # Common configuration for all Loki components
      commonConfig:
        # Single replica means replication_factor must be 1
        replication_factor: 1

      # Storage configuration
      storage:
        type: filesystem
        filesystem:
          chunks_directory: /var/loki/chunks
          rules_directory: /var/loki/rules

      # Schema configuration - required for Loki to work
      schemaConfig:
        configs:
          - from: "2024-04-01"
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: index_
              period: 24h
      # Limits configuration
      limits_config:
        # Allow structured metadata (labels extracted from logs)
        allow_structured_metadata: true
        # Enable per-stream volume limiting
        volume_enabled: true
        # Retention period (optional - keeps logs for 3 days)
        retention_period: 72h
        # Increase max query length to 3 days (set same as above)
        max_query_length: 72h
        # Per-stream rate limits
        ingestion_rate_mb: 10
        ingestion_bust_size_mb: 20
        per_stream_rate_limit: 5MB
        per_stream_rate_limit_burst: 10MB

      # Compactor configuration (cleans up old data)
      compactor:
        working_directory: /var/loki/compactor
        retention_enabled: true
        retention_delete_delay: 2h
        retention_delete_worker_count: 150
        
      # Ruler configuration (for alerting and recording rules)
      ruler:
        enable_api: true
        storage:
          type: local
          local:
            directory: /var/loki/rules
      
    # Single Binary configuration
    singleBinary:
      # Number of replicas - 1 for single replica, 3+ for HA
      replicas: 1

      # Resource requests and limits
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 1Gi

      # Persistence for Loki data
      persistence:
        enabled: true
        size: 5Gi
        storageClassName: local-path # k3s default storage class

      # Extra environment variables (if needed)
      extraEnv: []

      # Pod annotations (for Prometheus scraping)
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3100"
        
    # Zero out replica counts of other deployment modes
    backend:
      replicas: 0
    read:
      replicas: 0
    write:
      replicas: 0

    # MinIO for object storage (optional for now)
    # minio:
    #   enabled: true

    # Loki Gateway (NGINX reverse proxy)
    gateway:
      enabled: true
      replicas: 1
      service:
        type: ClusterIP
        port: 80
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # Monitoring components
    monitoring:
      # ServiceMonitor for Prometheus (since kube-prometheus-stack is used)
      serviceMonitor:
        enabled: true
        labels:
          release: kube-prometheus-stack # Match the Prometheus release name
      
      # Self-monitoring
      selfMonitoring:
        enabled: true
        grafanaAgent:
          installOperator: false

      # Loki Canary - tests the Loki pipeline
      lokiCanary:
        enabled: false

    # Test configuration
    test:
      enabled: false